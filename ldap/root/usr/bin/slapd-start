#!/bin/bash
# Author: TuxCoder
# Date: 22-01-2015
# 
# Script to genereate ldap config

BASE=$(echo "dc=${DOMAIN}" | sed "s/\./,dc=/")
URI=$LDAP_URI
PASSWORD=$LDAP_ROOTPASS


echo $SSL_KEY_PRIV | base64 -d > /etc/ldap/ssl/ldap.host.key
echo $SSL_KEY_CERT | base64 -d > /etc/ldap/ssl/ldap.host.crt

#replace placeholder in config
sed -i "s/__BASE__/${BASE}/g"          /etc/ldap/ldap.conf
sed -i "s#__URI__#${URI}#g"          /etc/ldap/ldap.conf
sed -i "s#__URI__#${URI}#g"          /etc/ldap/slapd.conf
sed -i "s/__BASE__/${BASE}/g"          /etc/ldap/slapd.conf
sed -i "s/__URI__/${BASE}/g"           /etc/ldap/slapd.conf
sed -i "s#__PASSWORD__#${PASSWORD}#g"  /etc/ldap/slapd.conf

#init
if [ ! -f /var/lib/ldap/DB_CONFIG ] && [ ! -f /etc/ldap/slapd.d/cn\=config ]; then
  #TODO think about that
  #rm /etc/ldap/slapd.d/* -R
  #rm /var/lib/ldap/* -R
  
  initldif="/tmp/slapd.init.ldif"
  cat /usr/share/slapd/slapd.init.ldif > ${initldif}
  sed -i -e "s|@BACKEND@|bdb|g" ${initldif}
  sed -i -e "s|@BACKENDOBJECTCLASS@|olcHdbConfig|g" ${initldif}
  sed -i -e "s|@BACKENDOPTIONS@|olcDbConfig: set_cachesize 0 2097152 0\nolcDbConfig: set_lk_max_objects 1500\nolcDbConfig: set_lk_max_locks 1500\nolcDbConfig: set_lk_max_lockers 1500|g" ${initldif}
  sed -i -e "s|@SUFFIX@|$BASE|g" ${initldif}
  sed -i -e "s|@PASSWORD@|$PASSWORD|g" ${initldif}

  slapadd -F "/etc/ldap/slapd.d" -b "cn=config" -l "${initldif}"
  rm ${initldif};
  find /etc/ldap/schema -name "*.ldif" | xargs  -n 1 slapadd -b "cn=config" -f /etc/ldap/slapd.conf -F /etc/ldap/slapd.d -l
  chown openldap:openldap -R /etc/ldap /var/lib/ldap
fi




/usr/sbin/slapd -f /etc/ldap/slapd.conf -F /etc/ldap/slapd.d -u openldap -g openldap -s 160



exit 0;
set -eu

status () {
  echo "---> ${@}" >&2
}

set -x
: LDAP_ROOTPASS=${LDAP_ROOTPASS}
: LDAP_DOMAIN=${LDAP_DOMAIN}
: LDAP_ORGANISATION=${LDAP_ORGANISATION}

if [ ! -e /var/lib/ldap/docker_bootstrapped ]; then
  status "configuring slapd for first run"

  cat <<EOF | debconf-set-selections
slapd slapd/internal/generated_adminpw password ${LDAP_ROOTPASS}
slapd slapd/internal/adminpw password ${LDAP_ROOTPASS}
slapd slapd/password2 password ${LDAP_ROOTPASS}
slapd slapd/password1 password ${LDAP_ROOTPASS}
slapd slapd/dump_database_destdir string /var/backups/slapd-VERSION
slapd slapd/domain string ${LDAP_DOMAIN}
slapd shared/organization string ${LDAP_ORGANISATION}
slapd slapd/backend string HDB
slapd slapd/purge_database boolean true
slapd slapd/move_old_database boolean true
slapd slapd/allow_ldap_v2 boolean false
slapd slapd/no_configuration boolean false
slapd slapd/dump_database select when needed
EOF

  dpkg-reconfigure -f noninteractive slapd
  touch /var/lib/ldap/docker_bootstrapped
else
  status "found already-configured slapd"
fi

status "starting slapd"
set -x
exec /usr/sbin/slapd -h "ldap:///" -u openldap -g openldap -s 160
